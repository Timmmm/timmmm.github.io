<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <meta name="author" content="" />
  <title>Using std in embedded Rust</title>
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
  </style>
  <link rel="stylesheet" href="../style.css" />
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<header id="title-block-header">
<h1 class="title">Using <code>std</code> in embedded Rust</h1>
<p class="author"></p>
<p class="date">19th April 2021</p>
</header>
<p>I recently asked <a href="question.html">a question</a> about using <a href="https://doc.rust-lang.org/std/">the Rust <code>std</code> library</a> in microcontrollers. It was closed by the StackOverflow question Nazis (quelle surprise), but I have figured out the answer myself so I will post it here where they can’t unilaterally execute it.</p>
<p>The question is: <strong>Can you use <code>std</code> in embedded Rust programming?</strong></p>
<p>A lot of readers are probably instinctively thinking “you shouldn’t do that!”, often for reasons <a href="question.html">like this</a>:</p>
<blockquote>
<p>on a microcontroller you generally don’t have enough memory to rely on a heap just being big enough for things like Vecs, so you just use arrays.</p>
</blockquote>
<p>That’s nonsense. Modern microcontrollers can have 1 MB of RAM or even more. That’s the minimum requirement for Windows 3.0! Also it’s common to use heap-allocated objects that are only allocated once at startup.</p>
<p>The real reason not to use a heap on microcontrollers is because it can fail at runtime, which on safety critical or high availability devices is a problem. But that doesn’t apply in most applications. Mbed and Arduino have had heaps for years.</p>
<figure>
<img src="Windows_3.0_workspace.png" alt="Windows 3.0. Probably used a heap." /><figcaption aria-hidden="true">Windows 3.0. Probably used a heap.</figcaption>
</figure>
<h2 id="my-original-motivation">My original motivation</h2>
<p>My original motivation was to be able to use containers like <a href="https://doc.rust-lang.org/std/vec/struct.Vec.html"><code>Vec</code></a> and <a href="https://doc.rust-lang.org/std/collections/struct.VecDeque.html"><code>VecDeque</code></a>. For some simple containers there is the <a href="https://crates.io/crates/heapless"><code>heapless</code></a> crate that provides non-heap versions of containers, but it doesn’t cover everything - for example it doesn’t include a version of <code>VecDeque</code>.</p>
<p>One of the StackOverflow comments pointed me to <a href="https://docs.rust-embedded.org/book/collections/index.html">an easier solution</a>: you can use <a href="https://doc.rust-lang.org/alloc/">the <code>alloc</code> crate</a> (not to be confused with <a href="https://doc.rust-lang.org/core/alloc/index.html"><code>core::alloc</code></a>) even in <code>#![no_std]</code> programs. <code>alloc</code> contains most of the functionality from <code>std</code> you might want to use on bare metal that isn’t in <code>core</code>. You just have to provide a memory allocator. A simple allocator is <a href="https://github.com/phil-opp/linked-list-allocator"><code>linked-list-allocator</code></a>. Let’s try it out!</p>
<h2 id="trying-out-alloc">Trying out <code>alloc</code></h2>
<figure>
<img src="cortex_m7.png" alt="ST Nucleo H743ZI2 Cortex-M7 development board with 1 MB of SRAM" /><figcaption aria-hidden="true">ST Nucleo H743ZI2 Cortex-M7 development board with 1 MB of SRAM</figcaption>
</figure>
<p>I followed the excellent <a href="https://docs.rust-embedded.org/book/start/qemu.html">Rust Embedded Book’s guide</a> to running a Cortex-M3 program on QEMU. Following the guide we get to the point where we can cross-compile the following example code to <code>thumbv7m-none-eabi</code> and run it.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode rust"><code class="sourceCode rust"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="at">#![</span>no_main<span class="at">]</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="at">#![</span>no_std<span class="at">]</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> panic_halt <span class="kw">as</span> _<span class="op">;</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">cortex_m_rt::</span>entry<span class="op">;</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">cortex_m_semihosting::</span><span class="op">{</span>debug<span class="op">,</span> hprintln<span class="op">};</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>entry<span class="at">]</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="kw">fn</span> main() <span class="op">-&gt;</span> <span class="op">!</span> <span class="op">{</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>    <span class="pp">hprintln!</span>(<span class="st">&quot;Hello, world!&quot;</span>)<span class="op">.</span>unwrap()<span class="op">;</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>    <span class="pp">debug::</span>exit(<span class="pp">debug::</span><span class="cn">EXIT_SUCCESS</span>)<span class="op">;</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">loop</span> <span class="op">{}</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<div class="sourceCode" id="cb2"><pre class="sourceCode shell"><code class="sourceCode shell"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="ot">$ cargo run --release</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>Finished release [optimized + debuginfo] target(s) in 0.14s</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a> Running `qemu-system-arm -cpu cortex-m3 -machine lm3s6965evb -nographic -semihosting-config enable=on,target=native -kernel target/thumbv7m-none-eabi/release/cortex-m-quickstart`</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>Hello, world!</span></code></pre></div>
<p>So far so good. What if we try to use the <code>alloc</code> crate?</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode rust"><code class="sourceCode rust"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="at">#![</span>no_main<span class="at">]</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="at">#![</span>no_std<span class="at">]</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> panic_halt <span class="kw">as</span> _<span class="op">;</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">cortex_m_rt::</span>entry<span class="op">;</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">cortex_m_semihosting::</span><span class="op">{</span>debug<span class="op">,</span> hprintln<span class="op">};</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="kw">extern</span> <span class="kw">crate</span> alloc<span class="op">;</span>   <span class="co">// 👈</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">alloc::vec::</span><span class="dt">Vec</span><span class="op">;</span>  <span class="co">// 👈</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>entry<span class="at">]</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a><span class="kw">fn</span> main() <span class="op">-&gt;</span> <span class="op">!</span> <span class="op">{</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="kw">mut</span> v <span class="op">=</span> <span class="dt">Vec</span><span class="pp">::</span>new()<span class="op">;</span>                <span class="co">// 👈</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>    v<span class="op">.</span>push(<span class="dv">5</span>)<span class="op">;</span>                             <span class="co">// 👈</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>    v<span class="op">.</span>push(<span class="dv">2</span>)<span class="op">;</span>                             <span class="co">// 👈</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>    v<span class="op">.</span>push(<span class="dv">5</span>)<span class="op">;</span>                             <span class="co">// 👈</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">for</span> x <span class="kw">in</span> v<span class="op">.</span>iter() <span class="op">{</span>                    <span class="co">// 👈</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>      <span class="pp">hprintln!</span>(<span class="st">&quot;Hello {}&quot;</span><span class="op">,</span> x)<span class="op">.</span>unwrap()<span class="op">;</span>   <span class="co">// 👈</span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span>                                      <span class="co">// 👈</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>    <span class="pp">debug::</span>exit(<span class="pp">debug::</span><span class="cn">EXIT_SUCCESS</span>)<span class="op">;</span></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">loop</span> <span class="op">{}</span></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Let’s try it:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode shell"><code class="sourceCode shell"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="ot">$ cargo run --release</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>    Compiling cortex-m-quickstart v0.1.0 (/Users/tim/cortex-m-quickstart)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a> <span class="er">error: no global memory allocator found but one is required; link to std or add `#[global_allocator]` to a static item that implements the GlobalAlloc trait.</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a> <span class="er">error[E0554]: `#![feature]` may not be used on the stable release channel</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>  --&gt; src/main.rs:3:1</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>   |</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a> 3 | #![feature(alloc)]    // 👈</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>   | ^^^^^^^^^^^^^^^^^^</span></code></pre></div>
<p>Ok there are two problems here:</p>
<ol type="1">
<li><code>alloc</code> is unstable so we have to use nightly, and</li>
<li>we haven’t provided an allocator.</li>
</ol>
<p>To add the allocator we can uncomment the <code>cortex-m-alloc</code> dependency in <code>Cargo.toml</code>:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode toml"><code class="sourceCode toml"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Uncomment for the allocator example.</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="dt">alloc-cortex-m</span> <span class="op">=</span> <span class="st">&quot;0.4.0&quot;</span></span></code></pre></div>
<p><a href="https://github.com/rust-embedded/alloc-cortex-m"><code>alloc-cortex-m</code></a> is a wrapper around <code>linked-list-allocator</code> that makes it interrupt safe for Cortex-M processors.</p>
<p>Then we can use it in the code. Conveniently there’s <a href="https://github.com/rust-embedded/cortex-m-quickstart/blob/master/examples/allocator.rs">an example at <code>examples/allocator.rs</code></a> that we can copy &amp; paste from:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode rust"><code class="sourceCode rust"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="at">#![</span>no_main<span class="at">]</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="at">#![</span>no_std<span class="at">]</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="at">#![</span>feature<span class="at">(</span>alloc_error_handler<span class="at">)]</span> <span class="co">// 👈</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> panic_halt <span class="kw">as</span> _<span class="op">;</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">cortex_m_rt::</span>entry<span class="op">;</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">cortex_m_semihosting::</span><span class="op">{</span>debug<span class="op">,</span> hprintln<span class="op">};</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a><span class="kw">extern</span> <span class="kw">crate</span> alloc<span class="op">;</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">alloc::vec::</span><span class="dt">Vec</span><span class="op">;</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">alloc_cortex_m::</span>CortexMHeap<span class="op">;</span>                        <span class="co">// 👈</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>                                                        <span class="co">// 👈</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a><span class="co">// this is the allocator the application will use       // 👈</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>global_allocator<span class="at">]</span>                                     <span class="co">// 👈</span></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a><span class="kw">static</span> ALLOCATOR<span class="op">:</span> CortexMHeap <span class="op">=</span> <span class="pp">CortexMHeap::</span>empty()<span class="op">;</span>   <span class="co">// 👈</span></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>                                                        <span class="co">// 👈</span></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> HEAP_SIZE<span class="op">:</span> <span class="dt">usize</span> <span class="op">=</span> <span class="dv">1024</span><span class="op">;</span> <span class="co">// in bytes              // 👈</span></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>entry<span class="at">]</span></span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a><span class="kw">fn</span> main() <span class="op">-&gt;</span> <span class="op">!</span> <span class="op">{</span></span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Initialize the allocator BEFORE you use it                             // 👈</span></span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>    <span class="kw">unsafe</span> <span class="op">{</span> ALLOCATOR<span class="op">.</span>init(<span class="pp">cortex_m_rt::</span>heap_start() <span class="kw">as</span> <span class="dt">usize</span><span class="op">,</span> HEAP_SIZE) <span class="op">}</span>  <span class="co">// 👈</span></span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="kw">mut</span> v <span class="op">=</span> <span class="dt">Vec</span><span class="pp">::</span>new()<span class="op">;</span></span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>    v<span class="op">.</span>push(<span class="dv">5</span>)<span class="op">;</span></span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>    v<span class="op">.</span>push(<span class="dv">2</span>)<span class="op">;</span></span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>    v<span class="op">.</span>push(<span class="dv">5</span>)<span class="op">;</span></span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a>    <span class="kw">for</span> x <span class="kw">in</span> v<span class="op">.</span>iter() <span class="op">{</span></span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a>      <span class="pp">hprintln!</span>(<span class="st">&quot;Hello {}&quot;</span><span class="op">,</span> x)<span class="op">.</span>unwrap()<span class="op">;</span></span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a>    <span class="pp">debug::</span>exit(<span class="pp">debug::</span><span class="cn">EXIT_SUCCESS</span>)<span class="op">;</span></span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a>    <span class="kw">loop</span> <span class="op">{}</span></span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true" tabindex="-1"></a><span class="co">// define what happens in an Out Of Memory (OOM) condition     // 👈</span></span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>alloc_error_handler<span class="at">]</span>                                         <span class="co">// 👈</span></span>
<span id="cb6-40"><a href="#cb6-40" aria-hidden="true" tabindex="-1"></a><span class="kw">fn</span> alloc_error(_layout<span class="op">:</span> <span class="pp">core::alloc::</span>Layout) <span class="op">-&gt;</span> <span class="op">!</span> <span class="op">{</span>            <span class="co">// 👈</span></span>
<span id="cb6-41"><a href="#cb6-41" aria-hidden="true" tabindex="-1"></a>    <span class="kw">loop</span> <span class="op">{}</span>                                                    <span class="co">// 👈</span></span>
<span id="cb6-42"><a href="#cb6-42" aria-hidden="true" tabindex="-1"></a><span class="op">}</span>                                                              <span class="co">// 👈</span></span></code></pre></div>
<p>Then compile using nightly:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode shell"><code class="sourceCode shell"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="ot">$ rustup +nightly target add thumbv7m-none-eabi</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>info: downloading component &#39;rust-std&#39; for &#39;thumbv7m-none-eabi&#39;</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>info: installing component &#39;rust-std&#39; for &#39;thumbv7m-none-eabi&#39;</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>info: using up to 500.0 MiB of RAM to unpack components</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="ot">$ cargo +nightly run --release</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>...</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>   Compiling cortex-m-quickstart v0.1.0 (/Users/tim/cortex-m-quickstart)</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>    Finished release [optimized + debuginfo] target(s) in 3.22s</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>     Running `qemu-system-arm -cpu cortex-m3 -machine lm3s6965evb -nographic -semihosting-config enable=on,target=native -kernel target/thumbv7m-none-eabi/release/cortex-m-quickstart`</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>Hello 5</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>Hello 2</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>Hello 5</span></code></pre></div>
<p>Success! But what happens if we try to use <code>std::vec::Vec</code> instead? Unfortunately as soon as we comment out <code>#![no_std]</code> we get this error:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode shell"><code class="sourceCode shell"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="ot">$ cargo +nightly run --release</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>   Compiling cortex-m-quickstart v0.1.0 (/Users/tim/cortex-m-quickstart)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="er">error[E0463]: can&#39;t find crate for `std`</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  |</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>  = note: the `thumbv7m-none-eabi` target may not be installed</span></code></pre></div>
<h2 id="what-about-full-std">What about full <code>std</code>?</h2>
<p>So this still left me wondering, what if I really do want to have <code>std</code> available? Can you do it? Let’s try!</p>
<p>What determines if <code>std</code> is available? It is sort of dictated by the target you are compiling for. The target is described by a “target triple” which is a barely consistent tuple of up to four parts (yep it’s inconsistent <em>and</em> badly named) describing the target architecture and platform that you are compiling for. There is a list of supported targets <a href="https://doc.rust-lang.org/nightly/rustc/platform-support.html">here</a>.</p>
<p>Notice that some of them do not support <code>std</code> (indicated by a <code>*</code>). For example <code>thumbv7m-none-eabi</code> which we are using does not, but <code>wasm32-unknown-unknown</code> does. Rust sensibly does not try to parse the target triple. Instead each target has a target spec, which you can print like this:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode shell"><code class="sourceCode shell"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="ot">$ rustc +nightly -Z unstable-options --print target-spec-json --target</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  &quot;arch&quot;: &quot;arm&quot;,</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  &quot;data-layout&quot;: &quot;e-m:e-p:32:32-Fi8-i64:64-v128:64:128-a:0:32-n32-S64&quot;,</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>  &quot;eliminate-frame-pointer&quot;: false,</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>  &quot;emit-debug-gdb-scripts&quot;: false,</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>  &quot;executables&quot;: true,</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>  &quot;is-builtin&quot;: true,</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>  &quot;linker&quot;: &quot;rust-lld&quot;,</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>  &quot;linker-flavor&quot;: &quot;ld.lld&quot;,</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>  &quot;llvm-target&quot;: &quot;thumbv7m-none-eabi&quot;,</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>  &quot;max-atomic-width&quot;: 32,</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>  &quot;panic-strategy&quot;: &quot;abort&quot;,</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>  &quot;relocation-model&quot;: &quot;static&quot;,</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>  &quot;target-pointer-width&quot;: &quot;32&quot;,</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>  &quot;unsupported-abis&quot;: [</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>    &quot;stdcall&quot;,</span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>    &quot;fastcall&quot;,</span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>    &quot;vectorcall&quot;,</span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>    &quot;thiscall&quot;,</span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>    &quot;win64&quot;,</span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>    &quot;sysv64&quot;</span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>  ]</span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<div class="sourceCode" id="cb10"><pre class="sourceCode shell"><code class="sourceCode shell"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="ot">$ rustc +nightly -Z unstable-options --print target-spec-json --target wasm32-unknown-unknown</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  &quot;arch&quot;: &quot;wasm32&quot;,</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>  &quot;crt-objects-fallback&quot;: &quot;wasm&quot;,</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>  &quot;data-layout&quot;: &quot;e-m:e-p:32:32-i64:64-n32:64-S128&quot;,</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>  &quot;default-hidden-visibility&quot;: true,</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>  &quot;dll-prefix&quot;: &quot;&quot;,</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>  &quot;dll-suffix&quot;: &quot;.wasm&quot;,</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>  &quot;dynamic-linking&quot;: true,</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>  &quot;eh-frame-header&quot;: false,</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>  &quot;emit-debug-gdb-scripts&quot;: false,</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>  &quot;exe-suffix&quot;: &quot;.wasm&quot;,</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>  &quot;executables&quot;: true,</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>  &quot;has-elf-tls&quot;: true,</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>  &quot;is-builtin&quot;: true,</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>  &quot;limit-rdylib-exports&quot;: false,</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>  &quot;linker&quot;: &quot;rust-lld&quot;,</span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>  &quot;linker-flavor&quot;: &quot;wasm-ld&quot;,</span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>  &quot;lld-flavor&quot;: &quot;wasm&quot;,</span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>  &quot;llvm-target&quot;: &quot;wasm32-unknown-unknown&quot;,</span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>  &quot;max-atomic-width&quot;: 64,</span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>  &quot;only-cdylib&quot;: true,</span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>  &quot;os&quot;: &quot;unknown&quot;,</span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>  &quot;panic-strategy&quot;: &quot;abort&quot;,</span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>  &quot;pre-link-args&quot;: {</span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>    &quot;gcc&quot;: [</span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>      &quot;-Wl,-z&quot;,</span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>      &quot;-Wl,stack-size=1048576&quot;,</span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a>      &quot;-Wl,--stack-first&quot;,</span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a>      &quot;-Wl,--allow-undefined&quot;,</span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a>      &quot;-Wl,--fatal-warnings&quot;,</span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a>      &quot;-Wl,--no-demangle&quot;,</span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a>      &quot;--target=wasm32-unknown-unknown&quot;,</span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a>      &quot;-Wl,--no-entry&quot;,</span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a>      &quot;-Wl,--export-dynamic&quot;</span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true" tabindex="-1"></a>    &quot;wasm-ld&quot;: [</span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true" tabindex="-1"></a>      &quot;-z&quot;,</span>
<span id="cb10-39"><a href="#cb10-39" aria-hidden="true" tabindex="-1"></a>      &quot;stack-size=1048576&quot;,</span>
<span id="cb10-40"><a href="#cb10-40" aria-hidden="true" tabindex="-1"></a>      &quot;--stack-first&quot;,</span>
<span id="cb10-41"><a href="#cb10-41" aria-hidden="true" tabindex="-1"></a>      &quot;--allow-undefined&quot;,</span>
<span id="cb10-42"><a href="#cb10-42" aria-hidden="true" tabindex="-1"></a>      &quot;--fatal-warnings&quot;,</span>
<span id="cb10-43"><a href="#cb10-43" aria-hidden="true" tabindex="-1"></a>      &quot;--no-demangle&quot;,</span>
<span id="cb10-44"><a href="#cb10-44" aria-hidden="true" tabindex="-1"></a>      &quot;--no-entry&quot;,</span>
<span id="cb10-45"><a href="#cb10-45" aria-hidden="true" tabindex="-1"></a>      &quot;--export-dynamic&quot;</span>
<span id="cb10-46"><a href="#cb10-46" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb10-47"><a href="#cb10-47" aria-hidden="true" tabindex="-1"></a>  },</span>
<span id="cb10-48"><a href="#cb10-48" aria-hidden="true" tabindex="-1"></a>  &quot;relocation-model&quot;: &quot;static&quot;,</span>
<span id="cb10-49"><a href="#cb10-49" aria-hidden="true" tabindex="-1"></a>  &quot;simd-types-indirect&quot;: false,</span>
<span id="cb10-50"><a href="#cb10-50" aria-hidden="true" tabindex="-1"></a>  &quot;singlethread&quot;: true,</span>
<span id="cb10-51"><a href="#cb10-51" aria-hidden="true" tabindex="-1"></a>  &quot;target-pointer-width&quot;: &quot;32&quot;,</span>
<span id="cb10-52"><a href="#cb10-52" aria-hidden="true" tabindex="-1"></a>  &quot;tls-model&quot;: &quot;local-exec&quot;</span>
<span id="cb10-53"><a href="#cb10-53" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Note the line <code>"os": "unknown",</code>. According to <a href="https://github.com/rust-lang/rust/blob/f900ee331dfe95493390e1beecb82a277158b60b/compiler/rustc_target/src/spec/mod.rs#L866">this comment</a>:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode rust"><code class="sourceCode rust"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// &quot;none&quot; implies a bare metal target without `std` library.</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// A couple of targets having `std` also use &quot;unknown&quot; as an `os` value,</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// but they are exceptions.</span></span></code></pre></div>
<p>Roughly, targets with <code>"os": "none"</code> (which is the default) do not have <code>std</code> available. However that’s not exactly how it works. You can actually build <code>std</code> for any target, even targets with <code>"os": "none"</code>. Let’s see how.</p>
<h2 id="standard-library-on-a-cortex-m3">Standard library on a Cortex M3</h2>
<p>Since the <code>thumbv7m-none-eabi</code> target does not come with a precompiled <code>std</code> installed we can use the <code>-Z build-std</code> option to tell Cargo to build <code>std</code> from source. <code>build-std</code> can be constrained to build only <code>core</code> or <code>core</code> and <code>alloc</code> but by default it builds <code>core</code>, <code>alloc</code> and <code>std</code> which is what we want.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode shell"><code class="sourceCode shell"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="ot">$ cargo +nightly build -Z build-std</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>  <span class="er">error: &quot;/Users/tim/.rustup/toolchains/nightly-x86_64-apple-darwin/lib/rustlib/src/rust/Cargo.lock&quot; does not exist, unable to build with the standard library, try:</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>          rustup component add rust-src</span></code></pre></div>
<p>Ok that makes sense, we need the source code for <code>std</code> to build it from source:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode shell"><code class="sourceCode shell"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="ot">$ rustup component add rust-src</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>info: component &#39;rust-src&#39; is up to date</span></code></pre></div>
<p>Err…</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode shell"><code class="sourceCode shell"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="ot">$ rustup +nightly component add rust-src</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>info: downloading component &#39;rust-src&#39;</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>info: installing component &#39;rust-src&#39;</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>info: using up to 500.0 MiB of RAM to unpack components</span></code></pre></div>
<p>Ah ok, fine.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode shell"><code class="sourceCode shell"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="ot">$ cargo +nightly build -Z build-std</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>   Compiling core v0.0.0 (/Users/tim/.rustup/toolchains/nightly-x86_64-apple-darwin/lib/rustlib/src/rust/library/core)</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>   Compiling compiler_builtins v0.1.39</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>   Compiling libc v0.2.88</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>   Compiling unwind v0.0.0 (/Users/tim/.rustup/toolchains/nightly-x86_64-apple-darwin/lib/rustlib/src/rust/library/unwind)</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>   Compiling std v0.0.0 (/Users/tim/.rustup/toolchains/nightly-x86_64-apple-darwin/lib/rustlib/src/rust/library/std)</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>   Compiling typenum v1.13.0</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>   Compiling cortex-m v0.7.2</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>   Compiling bare-metal v0.2.5</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>...</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>   Compiling generic-array v0.13.3</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>   Compiling generic-array v0.12.4</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>   Compiling as-slice v0.1.5</span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>   Compiling aligned v0.3.4</span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a><span class="er">error[E0463]: can&#39;t find crate for `panic_abort`</span></span></code></pre></div>
<p>This error stumped me. I thought I was doing wrong but eventually realised it happens even when using <code>build-std</code> for the <code>wasm32-unknown-unknown</code> target which is a <code>std</code>-enabled target. <a href="https://github.com/rust-lang/rust/issues/83805#issuecomment-812874115">It turns out it is a bug with <code>build-std</code></a>. It doesn’t know how to handle <code>panic_abort</code> vs <code>panic_unwind</code> so it doesn’t use either crate, resulting in the above error. It can be fixed like this:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode shell"><code class="sourceCode shell"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="ot">$ cargo +nightly build -Z build-std=std,panic_abort</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>   Compiling core v0.0.0 (/Users/tim/.rustup/toolchains/nightly-x86_64-apple-darwin/lib/rustlib/src/rust/library/core)</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>   Compiling cortex-m-quickstart v0.1.0 (/Users/tim/workspace/cortex-m-quickstart)</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>   Compiling compiler_builtins v0.1.39</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>   Compiling libc v0.2.88</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>   Compiling unwind v0.0.0 (/Users/tim/.rustup/toolchains/nightly-x86_64-apple-darwin/lib/rustlib/src/rust/library/unwind)</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>   Compiling std v0.0.0 (/Users/tim/.rustup/toolchains/nightly-x86_64-apple-darwin/lib/rustlib/src/rust/library/std)</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>   Compiling rustc-std-workspace-core v1.99.0 (/Users/tim/.rustup/toolchains/nightly-x86_64-apple-darwin/lib/rustlib/src/rust/library/rustc-std-workspace-core)</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>   Compiling alloc v0.0.0 (/Users/tim/.rustup/toolchains/nightly-x86_64-apple-darwin/lib/rustlib/src/rust/library/alloc)</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>   Compiling cfg-if v0.1.10</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>   Compiling adler v0.2.3</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>   Compiling rustc-demangle v0.1.18</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>   Compiling panic_abort v0.0.0 (/Users/tim/.rustup/toolchains/nightly-x86_64-apple-darwin/lib/rustlib/src/rust/library/panic_abort)</span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>   Compiling rustc-std-workspace-alloc v1.99.0 (/Users/tim/.rustup/toolchains/nightly-x86_64-apple-darwin/lib/rustlib/src/rust/library/rustc-std-workspace-alloc)</span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>   Compiling panic_unwind v0.0.0 (/Users/tim/.rustup/toolchains/nightly-x86_64-apple-darwin/lib/rustlib/src/rust/library/panic_unwind)</span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>   Compiling gimli v0.23.0</span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>   Compiling object v0.22.0</span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>   Compiling miniz_oxide v0.4.0</span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>   Compiling hashbrown v0.11.0</span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a>   Compiling addr2line v0.14.0</span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>   Compiling proc_macro v0.0.0 (/Users/tim/.rustup/toolchains/nightly-x86_64-apple-darwin/lib/rustlib/src/rust/library/proc_macro)</span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a><span class="er">error[E0658]: use of unstable library feature &#39;restricted_std&#39;</span></span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a>  |</span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a>  = help: add `#![feature(restricted_std)]` to the crate attributes to enable</span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a><span class="er">error: aborting due to previous error</span></span></code></pre></div>
<p>There’s <a href="https://doc.rust-lang.org/nightly/unstable-book/library-features/restricted-std.html">not much documentation on this error</a>, but I managed to figure out what this means.</p>
<p>Basically platform-dependent parts of <code>std</code> - such as threading and filesystem access - are in <a href="https://github.com/rust-lang/rust/tree/master/library/std/src/sys">the <code>sys</code> crate</a>. There is an implementation of <code>sys</code> inside <code>std</code> for each platform that Rust supports. The selected implementation <a href="https://github.com/rust-lang/rust/blob/master/library/std/src/sys/mod.rs">is determined mostly by the <code>os</code> field of the target spec</a>. If the <code>os</code> is <code>none</code> then it uses <a href="https://github.com/rust-lang/rust/tree/master/library/std/src/sys/unsupported">the <code>unsupported</code> implementation</a> in which all operations fail or do nothing.</p>
<figure>
<img src="crates.svg" alt="Roughly how the crates work." /><figcaption aria-hidden="true">Roughly how the crates work.</figcaption>
</figure>
<p>When <code>std</code> is built, if the target does not match <a href="https://github.com/rust-lang/rust/blob/master/library/std/build.rs">one of these whitelisted targets</a> then the <code>restricted_std</code> feature is required to indicate that that build of <code>std</code> is not supported. I am not really sure why the whitelist does not match the logic for selecting the <code>sys</code> implementation but I’m sure there’s a reason.</p>
<p>To tell Rust we’re ok with using the unsupported <code>std</code>, just add <code>#![feature(restricted_std)]</code> at the start of <code>main.rs</code>.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode shell"><code class="sourceCode shell"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="ot">$ cargo +nightly build -Z build-std=std,panic_abort</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>   Compiling cortex-m-quickstart v0.1.0 (/Users/tim/cortex-m-quickstart)</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="er">error: duplicate lang item in crate `panic_halt` (which `cortex_m_quickstart` depends on): `panic_impl`.</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>  |</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>  = note: the lang item is first defined in crate `std` (which `cortex_m_quickstart` depends on)</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>  = note: first definition in `std` loaded from /Users/tim/cortex-m-quickstart/target/thumbv7m-none-eabi/debug/deps/libstd-7973440d226ad430.rlib</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>  = note: second definition in `panic_halt` loaded from /Users/tim/cortex-m-quickstart/target/thumbv7m-none-eabi/debug/deps/libpanic_halt-9309434d713d3da0.rlib</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a><span class="er">error[E0152]: found duplicate lang item `oom`</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>  --&gt; src/main.rs:41:1</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>   |</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>41 | fn alloc_error(_layout: core::alloc::Layout) -&gt; ! {</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>   | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>   |</span></code></pre></div>
<p><code>std</code> provides its own OOM handler so we can just delete that function. We also need to remove our custom panic handler. Comment out the dependency in <code>Cargo.toml</code>, and the <code>use</code> in <code>main.rs</code>:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode toml"><code class="sourceCode toml"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># panic-halt = &quot;0.2.0&quot;</span></span></code></pre></div>
<div class="sourceCode" id="cb19"><pre class="sourceCode rust"><code class="sourceCode rust"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co">// use panic_halt as _;</span></span></code></pre></div>
<p>The final code is</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode rust"><code class="sourceCode rust"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="at">#![</span>no_main<span class="at">]</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="at">#![</span>feature<span class="at">(</span>alloc_error_handler<span class="at">)]</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="at">#![</span>feature<span class="at">(</span>restricted_std<span class="at">)]</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">cortex_m_rt::</span>entry<span class="op">;</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">cortex_m_semihosting::</span><span class="op">{</span>debug<span class="op">,</span> hprintln<span class="op">};</span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">alloc_cortex_m::</span>CortexMHeap<span class="op">;</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a><span class="co">// this is the allocator the application will use</span></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>global_allocator<span class="at">]</span></span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a><span class="kw">static</span> ALLOCATOR<span class="op">:</span> CortexMHeap <span class="op">=</span> <span class="pp">CortexMHeap::</span>empty()<span class="op">;</span></span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> HEAP_SIZE<span class="op">:</span> <span class="dt">usize</span> <span class="op">=</span> <span class="dv">1024</span><span class="op">;</span> <span class="co">// in bytes</span></span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>entry<span class="at">]</span></span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a><span class="kw">fn</span> main() <span class="op">-&gt;</span> <span class="op">!</span> <span class="op">{</span></span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Initialize the allocator BEFORE you use it</span></span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">unsafe</span> <span class="op">{</span> ALLOCATOR<span class="op">.</span>init(<span class="pp">cortex_m_rt::</span>heap_start() <span class="kw">as</span> <span class="dt">usize</span><span class="op">,</span> HEAP_SIZE) <span class="op">}</span></span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="kw">mut</span> v <span class="op">=</span> <span class="dt">Vec</span><span class="pp">::</span>new()<span class="op">;</span></span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a>    v<span class="op">.</span>push(<span class="dv">5</span>)<span class="op">;</span></span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a>    v<span class="op">.</span>push(<span class="dv">2</span>)<span class="op">;</span></span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a>    v<span class="op">.</span>push(<span class="dv">5</span>)<span class="op">;</span></span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">for</span> x <span class="kw">in</span> v<span class="op">.</span>iter() <span class="op">{</span></span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true" tabindex="-1"></a>      <span class="pp">hprintln!</span>(<span class="st">&quot;Hello {}&quot;</span><span class="op">,</span> x)<span class="op">.</span>unwrap()<span class="op">;</span></span>
<span id="cb20-27"><a href="#cb20-27" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb20-28"><a href="#cb20-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-29"><a href="#cb20-29" aria-hidden="true" tabindex="-1"></a>    <span class="pp">debug::</span>exit(<span class="pp">debug::</span><span class="cn">EXIT_SUCCESS</span>)<span class="op">;</span></span>
<span id="cb20-30"><a href="#cb20-30" aria-hidden="true" tabindex="-1"></a>    <span class="kw">loop</span> <span class="op">{}</span></span>
<span id="cb20-31"><a href="#cb20-31" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Note that I changed it to use <code>std::vec::Vec</code> instead of <code>alloc::vec::Vec</code>. Let’s try it.</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode shell"><code class="sourceCode shell"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="ot">$ cargo +nightly build -Z build-std=std,panic_abort</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>   Compiling cortex-m-quickstart v0.1.0 (/Users/tim/cortex-m-quickstart)</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>    Finished dev [unoptimized + debuginfo] target(s) in 0.36s</span></code></pre></div>
<p>It compiled! Does it run?</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode shell"><code class="sourceCode shell"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="ot">$ cargo +nightly run -Z build-std=std,panic_abort</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>    Finished dev [unoptimized + debuginfo] target(s) in 0.10s</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>     Running `qemu-system-arm -cpu cortex-m3 -machine lm3s6965evb -nographic -semihosting-config enable=on,target=native -kernel target/thumbv7m-none-eabi/debug/cortex-m-quickstart`</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>Hello 5</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>Hello 2</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>Hello 5</span></code></pre></div>
<p>Oh my god it actually worked. We just compiled and ran a bare metal Cortex-M3 program that uses <code>std</code>. Take <em>THAT</em> StackOverflow know-it-alls.</p>
<h2 id="why-this-isnt-stupid">Why this isn’t stupid</h2>
<p>In most bare metal situations you only need <code>core</code> and <code>alloc</code>. <code>std</code> mostly exposes items from <code>core</code> or <code>alloc</code>. The exceptions are functions normally provided by an OS like <a href="https://doc.rust-lang.org/std/net/index.html">network access</a>, <a href="https://doc.rust-lang.org/std/process/index.html">running processes</a> and <a href="https://doc.rust-lang.org/std/fs/index.html">using files</a>. Those things rely on <a href="https://github.com/rust-lang/rust/tree/master/library/std/src/sys">the <code>sys</code> crate</a>.</p>
<p>Those operations do make sense on bare metal! We might want to provide a virtual filesystem for example, and plenty of microcontrollers support network features. Unfortunately the implementations are all embedded in the compiler - there is no way to define your own though that <a href="https://github.com/rust-lang/rust/blob/master/library/std/src/sys/mod.rs#L16">is planned eventually</a>:</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode rust"><code class="sourceCode rust"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co">//! In the future it would be desirable for the independent</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="co">//! implementations of this module to be extracted to their own crates</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="co">//! that `std` can link to, thus enabling their implementation</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="co">//! out-of-tree via crate replacement. Though due to the complex</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a><span class="co">//! inter-dependencies within `std` that will be a challenging goal to</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a><span class="co">//! achieve.</span></span></code></pre></div>
<p>However there are still some compelling reasons to use <code>std</code>:</p>
<ol type="1">
<li><a href="https://github.com/rust-lang/rust/issues/27242"><code>HashMap</code> is only available in <code>std</code>.</a></li>
<li><a href="https://github.com/rust-lang/rust/issues/62502"><code>Error</code> is only available in <code>std</code>.</a></li>
<li>You can use <code>std</code> crates.</li>
<li><del><a href="https://ferrous-systems.com/blog/embedded-async-await/"><code>async</code>/<code>await</code> only works in <code>std</code></a></del> <em>Edit: <a href="https://www.reddit.com/r/rust/comments/mtyd44/using_std_in_embedded_rust/gv2vv4a/?utm_source=reddit&amp;utm_medium=web2x&amp;context=3">maybe not</a>.</em></li>
</ol>
<p>Unfortunately there are some serious caveats so I would probably stick to <code>core</code> and <code>alloc</code> for now. Specifically:</p>
<ol type="1">
<li>You can’t use <code>HashMap</code> with the default hasher because it uses <code>thread_local!()</code> which requires support from <code>sys</code>.</li>
<li>I think the same issue applies to <code>async</code>/<code>await</code> though I haven’t tested it.</li>
<li>You actually can’t use <code>std</code> dependencies because there’s no way to pass <code>#[feature(restricted_std)]</code> to them as far as I can tell. Every crate needs that feature, not just the root one.</li>
</ol>
<p>Anyway here is a simple program to demonstrate some <code>std</code>-only features.</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode rust"><code class="sourceCode rust"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="at">#![</span>no_main<span class="at">]</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="at">#![</span>feature<span class="at">(</span>alloc_error_handler<span class="at">)]</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="at">#![</span>feature<span class="at">(</span>restricted_std<span class="at">)]</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">cortex_m_rt::</span>entry<span class="op">;</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">cortex_m_semihosting::</span><span class="op">{</span>debug<span class="op">,</span> hprintln<span class="op">};</span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">std::</span><span class="op">{</span></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>    <span class="pp">collections::</span><span class="op">{</span>HashMap<span class="op">,</span> <span class="pp">hash_map::</span>DefaultHasher<span class="op">},</span></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>    <span class="pp">hash::</span><span class="op">{</span><span class="bu">BuildHasher</span><span class="op">,</span> BuildHasherDefault<span class="op">},</span></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>                                                         <span class="co">// 👇</span></span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> Result<span class="op">&lt;</span>T<span class="op">&gt;</span> <span class="op">=</span> <span class="pp">std::result::</span><span class="dt">Result</span><span class="op">&lt;</span>T<span class="op">,</span> <span class="dt">Box</span><span class="op">&lt;</span><span class="kw">dyn</span> <span class="pp">std::error::</span><span class="bu">Error</span><span class="op">&gt;&gt;;</span></span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">alloc_cortex_m::</span>CortexMHeap<span class="op">;</span></span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a><span class="co">// this is the allocator the application will use</span></span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>global_allocator<span class="at">]</span></span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a><span class="kw">static</span> ALLOCATOR<span class="op">:</span> CortexMHeap <span class="op">=</span> <span class="pp">CortexMHeap::</span>empty()<span class="op">;</span></span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> HEAP_SIZE<span class="op">:</span> <span class="dt">usize</span> <span class="op">=</span> <span class="dv">1024</span><span class="op">;</span> <span class="co">// in bytes</span></span>
<span id="cb24-23"><a href="#cb24-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-24"><a href="#cb24-24" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>entry<span class="at">]</span></span>
<span id="cb24-25"><a href="#cb24-25" aria-hidden="true" tabindex="-1"></a><span class="kw">fn</span> main() <span class="op">-&gt;</span> <span class="op">!</span> <span class="op">{</span></span>
<span id="cb24-26"><a href="#cb24-26" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Initialize the allocator BEFORE you use it</span></span>
<span id="cb24-27"><a href="#cb24-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">unsafe</span> <span class="op">{</span> ALLOCATOR<span class="op">.</span>init(<span class="pp">cortex_m_rt::</span>heap_start() <span class="kw">as</span> <span class="dt">usize</span><span class="op">,</span> HEAP_SIZE) <span class="op">}</span></span>
<span id="cb24-28"><a href="#cb24-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-29"><a href="#cb24-29" aria-hidden="true" tabindex="-1"></a>             <span class="co">// 👇</span></span>
<span id="cb24-30"><a href="#cb24-30" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="kw">mut</span> v <span class="op">=</span> <span class="pp">HashMap::</span>with_hasher(<span class="pp">BuildHasherDefault::</span><span class="op">&lt;</span>DefaultHasher<span class="op">&gt;</span><span class="pp">::</span><span class="kw">default</span>())<span class="op">;</span></span>
<span id="cb24-31"><a href="#cb24-31" aria-hidden="true" tabindex="-1"></a>    v<span class="op">.</span>insert(<span class="dv">1</span><span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb24-32"><a href="#cb24-32" aria-hidden="true" tabindex="-1"></a>    <span class="kw">match</span> get_zero(<span class="op">&amp;</span>v) <span class="op">{</span></span>
<span id="cb24-33"><a href="#cb24-33" aria-hidden="true" tabindex="-1"></a>        <span class="cn">Ok</span>(x) <span class="op">=&gt;</span> <span class="pp">hprintln!</span>(<span class="st">&quot;Element 0 is {}&quot;</span><span class="op">,</span> x)<span class="op">.</span>unwrap()<span class="op">,</span></span>
<span id="cb24-34"><a href="#cb24-34" aria-hidden="true" tabindex="-1"></a>        <span class="cn">Err</span>(e) <span class="op">=&gt;</span> <span class="pp">hprintln!</span>(<span class="st">&quot;Error: {}&quot;</span><span class="op">,</span> e)<span class="op">.</span>unwrap()<span class="op">,</span></span>
<span id="cb24-35"><a href="#cb24-35" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb24-36"><a href="#cb24-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-37"><a href="#cb24-37" aria-hidden="true" tabindex="-1"></a>    <span class="pp">debug::</span>exit(<span class="pp">debug::</span><span class="cn">EXIT_SUCCESS</span>)<span class="op">;</span></span>
<span id="cb24-38"><a href="#cb24-38" aria-hidden="true" tabindex="-1"></a>    <span class="kw">loop</span> <span class="op">{}</span></span>
<span id="cb24-39"><a href="#cb24-39" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb24-40"><a href="#cb24-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-41"><a href="#cb24-41" aria-hidden="true" tabindex="-1"></a><span class="kw">fn</span> get_zero<span class="op">&lt;</span>S<span class="op">:</span> <span class="bu">BuildHasher</span><span class="op">&gt;</span>(x<span class="op">:</span> <span class="op">&amp;</span>HashMap<span class="op">&lt;</span><span class="dt">u32</span><span class="op">,</span> <span class="dt">u32</span><span class="op">,</span> S<span class="op">&gt;</span>) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span><span class="dt">u32</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb24-42"><a href="#cb24-42" aria-hidden="true" tabindex="-1"></a>    <span class="cn">Ok</span>(<span class="op">*</span>x<span class="op">.</span>get(<span class="op">&amp;</span><span class="dv">0</span>)<span class="op">.</span>ok_or(<span class="st">&quot;Missing element 0&quot;</span>)<span class="op">?</span>)</span>
<span id="cb24-43"><a href="#cb24-43" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<div class="sourceCode" id="cb25"><pre class="sourceCode shell"><code class="sourceCode shell"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="ot">$ cargo +nightly run -Z build-std=std,panic_abort</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>   Compiling cortex-m-quickstart v0.1.0 (/Users/tim/cortex-m-quickstart)</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>    Finished dev [unoptimized + debuginfo] target(s) in 1.22s</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>     Running `qemu-system-arm -cpu cortex-m3 -machine lm3s6965evb -nographic -semihosting-config enable=on,target=native -kernel target/thumbv7m-none-eabi/debug/cortex-m-quickstart`</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a><span class="er">Error: Missing element 0</span></span></code></pre></div>
<p>Success! (It’s supposed to print an error.)</p>
<p>It’s not quite there yet but the <em>idea</em> of using <code>std</code> on bare metal isn’t crazy. Hopefully one day we will be able to supply a custom <code>sys</code> crate for bare metal targets and easily use <code>std</code> everywhere.</p>
</body>
</html>
